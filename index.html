<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birdhunt</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #05070a;
      overflow: hidden;
      height: 100%;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: #e8f0ff;
      user-select: none;
    }
    #wrap { position: fixed; inset: 0; }
    canvas {
      width: 100vw !important;
      height: 100vh !important;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      display: block;
      outline: none;
    }

    /* HUD */
    #hud {
      position: fixed;
      inset: 0;
      pointer-events: none;
    }
    #topLeft {
      position: absolute;
      left: 14px;
      top: 12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      font-size: 14px;
      line-height: 1.35;
      backdrop-filter: blur(4px);
      min-width: 220px;
    }
    #topLeft .muted { opacity: 0.75; font-weight: 500; }
    #topLeft .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #bar {
      width: 170px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }
    #barFill {
      height: 100%;
      width: 100%;
      background: rgba(200,255,200,0.8);
    }

    /* Crosshair */
    #crosshair {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 14px;
      height: 14px;
      transform: translate(-50%, -50%);
      opacity: 0.92;
      filter: drop-shadow(0 0 6px rgba(0,0,0,0.45));
    }
    #crosshair::before, #crosshair::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      background: rgba(255,255,255,0.92);
      transform: translate(-50%, -50%);
      border-radius: 2px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.35);
    }
    #crosshair::before { width: 12px; height: 2px; }
    #crosshair::after  { width: 2px; height: 12px; }

    /* Center message */
    #msg {
      position: absolute;
      left: 50%;
      top: 62%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 800;
      letter-spacing: 0.2px;
      opacity: 0;
      transition: opacity 120ms linear;
      backdrop-filter: blur(4px);
      text-align: center;
      max-width: min(80vw, 520px);
    }
    #msg.show { opacity: 1; }

    /* Home screen */
    #menu {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background:
        radial-gradient(1200px 800px at 50% 30%, rgba(40,70,60,0.55), rgba(5,7,10,0.98)),
        linear-gradient(180deg, rgba(10,20,30,0.6), rgba(0,0,0,0.95));
      z-index: 10;
    }
    #card {
      width: min(760px, calc(100vw - 28px));
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.42);
      box-shadow: 0 20px 90px rgba(0,0,0,0.55);
      padding: 18px;
      backdrop-filter: blur(10px);
    }
    #title {
      font-size: 34px;
      font-weight: 900;
      letter-spacing: 0.5px;
      margin: 2px 0 6px;
    }
    #subtitle {
      margin: 0 0 14px;
      opacity: 0.82;
      font-weight: 650;
      line-height: 1.4;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 14px;
    }
    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
    }
    .panel {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.04);
      padding: 12px;
    }
    .panel h3 {
      margin: 0 0 8px;
      font-size: 14px;
      opacity: 0.9;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .panel ul {
      margin: 0;
      padding-left: 18px;
      opacity: 0.9;
      line-height: 1.5;
      font-weight: 650;
      font-size: 14px;
    }
    .btnRow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: #e8f0ff;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 850;
      cursor: pointer;
      letter-spacing: 0.2px;
    }
    button:hover { background: rgba(255,255,255,0.16); }
    button.primary {
      background: rgba(120,210,160,0.22);
      border-color: rgba(120,210,160,0.45);
    }
    button.primary:hover { background: rgba(120,210,160,0.30); }

    .small {
      opacity: 0.85;
      font-weight: 650;
      font-size: 13px;
      line-height: 1.4;
      margin-top: 10px;
    }
    .kbd {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    /* Settings rows */
    .settingRow {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .settingRow label {
      font-weight: 800;
      opacity: 0.9;
      font-size: 13px;
    }
    input[type="range"] {
      width: 220px;
      accent-color: rgba(120,210,160,1);
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.20);
      font-weight: 900;
      font-size: 12px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div id="wrap"></div>

  <div id="hud">
    <div id="topLeft">
      <div class="row">
        <div>Score: <span id="score">0</span></div>
        <div class="muted">Time: <span id="time">60</span>s</div>
      </div>
      <div class="row" style="margin-top:6px;">
        <div>Ammo: <span id="ammo">16</span>/<span id="ammoMax">16</span></div>
        <div id="bar"><div id="barFill"></div></div>
      </div>
      <div class="muted" style="margin-top:6px;">
        Click shoot • R reload • WASD move • Shift sprint • Esc pause
      </div>
      <div class="muted" style="margin-top:4px;">
        Best: <span id="best">0</span> <span class="pill" id="streakPill" style="display:none;">Streak x1</span>
      </div>
    </div>
    <div id="crosshair"></div>
    <div id="msg"></div>
  </div>

  <div id="menu">
    <div id="card">
      <div id="title">BIRDHUNT</div>
      <div id="subtitle">Pixel styled first person bird shooting in a moody forest. Fast, clean, and simple.</div>

      <div class="grid">
        <div class="panel">
          <h3>How It Works</h3>
          <ul>
            <li>Birds fly over the treeline. Shoot them for points.</li>
            <li>Head toward open areas for clearer shots.</li>
            <li>You have 60 seconds. Reload anytime.</li>
            <li>Trackpad friendly: Start then click once inside.</li>
          </ul>

          <div class="settingRow">
            <label for="sens">Mouse sensitivity</label>
            <input id="sens" type="range" min="0.2" max="2.5" step="0.05" value="1.0" />
            <span class="pill" id="sensVal">1.00</span>
          </div>

          <div class="settingRow">
            <label for="audio">Sound</label>
            <input id="audio" type="range" min="0" max="100" step="1" value="45" />
            <span class="pill" id="audioVal">45</span>
          </div>

          <div class="small" id="tips" style="display:none;">
            Tip: If pointer lock is blocked, click Start again, then click inside the game. Some browsers require that second click.
          </div>
        </div>

        <div class="panel">
          <h3>Controls</h3>
          <ul>
            <li><span class="kbd">W</span> <span class="kbd">A</span> <span class="kbd">S</span> <span class="kbd">D</span> move</li>
            <li>Mouse look</li>
            <li>Click shoot</li>
            <li><span class="kbd">R</span> reload</li>
            <li><span class="kbd">Shift</span> sprint</li>
            <li><span class="kbd">Esc</span> pause</li>
          </ul>
          <div class="small">
            Your goal is clean accuracy. Hit streaks for small bonus points.
          </div>
        </div>
      </div>

      <div class="btnRow">
        <button class="primary" id="startBtn">Start</button>
        <button id="howBtn">Toggle Tips</button>
        <button id="qualityBtn">Pixel Quality: Medium</button>
        <button id="restartBtn">Restart</button>
      </div>

      <div class="small" id="endStats" style="display:none; margin-top:10px;"></div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { PointerLockControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js";

    const wrap = document.getElementById("wrap");
    const scoreEl = document.getElementById("score");
    const timeEl = document.getElementById("time");
    const ammoEl = document.getElementById("ammo");
    const ammoMaxEl = document.getElementById("ammoMax");
    const barFill = document.getElementById("barFill");
    const msgEl = document.getElementById("msg");

    const menu = document.getElementById("menu");
    const startBtn = document.getElementById("startBtn");
    const howBtn = document.getElementById("howBtn");
    const qualityBtn = document.getElementById("qualityBtn");
    const restartBtn = document.getElementById("restartBtn");
    const tips = document.getElementById("tips");
    const endStats = document.getElementById("endStats");

    const sensSlider = document.getElementById("sens");
    const sensVal = document.getElementById("sensVal");
    const audioSlider = document.getElementById("audio");
    const audioVal = document.getElementById("audioVal");

    const bestEl = document.getElementById("best");
    const streakPill = document.getElementById("streakPill");

    function showMsg(text, ms = 900) {
      msgEl.textContent = text;
      msgEl.classList.add("show");
      window.clearTimeout(showMsg._t);
      showMsg._t = window.setTimeout(() => msgEl.classList.remove("show"), ms);
    }

    /* Local best score */
    const BEST_KEY = "birdhunt_best_v1";
    function loadBest() {
      const v = Number(localStorage.getItem(BEST_KEY) || "0");
      return Number.isFinite(v) ? v : 0;
    }
    function saveBest(v) {
      localStorage.setItem(BEST_KEY, String(v));
    }
    let bestScore = loadBest();
    bestEl.textContent = String(bestScore);

    /* Audio */
    let audioCtx = null;
    let audioGain = null;
    function ensureAudio() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      audioGain = audioCtx.createGain();
      audioGain.gain.value = (Number(audioSlider.value) / 100) * 0.12;
      audioGain.connect(audioCtx.destination);
    }
    function setAudioVolume() {
      if (!audioGain) return;
      audioGain.gain.value = (Number(audioSlider.value) / 100) * 0.12;
    }
    function beep(freq = 440, dur = 0.06, type = "square") {
      if (!audioCtx || !audioGain) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = 0.8;
      o.connect(g);
      g.connect(audioGain);
      o.start();
      o.stop(audioCtx.currentTime + dur);
    }

    /* Pixel resolution presets */
    const qualityPresets = [
      { name: "Low",    w: 320, h: 180 },
      { name: "Medium", w: 426, h: 240 },
      { name: "High",   w: 640, h: 360 },
      { name: "Ultra",  w: 854, h: 480 },
    ];
    let qualityIndex = 1;

    /* Game settings */
    const GAME_SECONDS = 60;
    const MAG_SIZE = 16;

    /* Scene */
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x07100a, 0.028);

    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 420);
    camera.position.set(0, 1.7, 8);

    const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
    renderer.setPixelRatio(1);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.domElement.tabIndex = 0;
    renderer.domElement.style.cursor = "crosshair";
    wrap.appendChild(renderer.domElement);

    /* Controls */
    const controls = new PointerLockControls(camera, renderer.domElement);
    scene.add(controls.getObject());

    let mouseSensitivity = 1.0;
    controls.pointerSpeed = mouseSensitivity;

    /* Lighting */
    const hemi = new THREE.HemisphereLight(0xb6d7ff, 0x0b140a, 0.75);
    scene.add(hemi);

    const sun = new THREE.DirectionalLight(0xffffff, 0.9);
    sun.position.set(40, 60, 20);
    scene.add(sun);

    /* Ground */
    const groundGeo = new THREE.PlaneGeometry(260, 260, 1, 1);
    const groundMat = new THREE.MeshLambertMaterial({ color: 0x103016 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = 0;
    scene.add(ground);

    /* Subtle path ring to give direction */
    const pathGeo = new THREE.RingGeometry(10, 44, 64);
    const pathMat = new THREE.MeshBasicMaterial({ color: 0x0e2515, transparent: true, opacity: 0.25, side: THREE.DoubleSide });
    const path = new THREE.Mesh(pathGeo, pathMat);
    path.rotation.x = -Math.PI / 2;
    path.position.y = 0.02;
    scene.add(path);

    /* Sky dome */
    const skyGeo = new THREE.SphereGeometry(170, 22, 16);
    const skyMat = new THREE.MeshBasicMaterial({ color: 0x07141e, side: THREE.BackSide });
    const sky = new THREE.Mesh(skyGeo, skyMat);
    scene.add(sky);

    /* Distant mountains */
    function makeMountain() {
      const g = new THREE.ConeGeometry(18, 22, 6, 1);
      const m = new THREE.MeshLambertMaterial({ color: 0x0a1413 });
      const mesh = new THREE.Mesh(g, m);
      mesh.position.y = 8;
      mesh.rotation.y = Math.random() * Math.PI * 2;
      return mesh;
    }
    for (let i = 0; i < 16; i++) {
      const a = (i / 16) * Math.PI * 2;
      const r = 120 + Math.random() * 18;
      const mount = makeMountain();
      mount.position.x = Math.cos(a) * r;
      mount.position.z = Math.sin(a) * r;
      mount.scale.setScalar(1.0 + Math.random() * 1.2);
      scene.add(mount);
    }

    /* Pixel billboard trees */
    function makeTreeTexture(seed = 0) {
      const c = document.createElement("canvas");
      c.width = 32;
      c.height = 64;
      const g = c.getContext("2d");

      g.clearRect(0, 0, c.width, c.height);

      g.fillStyle = "#3a2a1a";
      g.fillRect(14, 40, 4, 18);

      const greens = ["#1a5b2a", "#1f6a31", "#144d24", "#2a7a3b", "#0f3f1f"];
      function px(x,y,w,h,color){ g.fillStyle = color; g.fillRect(x,y,w,h); }

      const blocks = [
        [10, 26, 12, 10],
        [8,  22, 16, 8],
        [12, 18, 8,  6],
        [6,  30, 20, 10],
        [10, 34, 12, 8],
        [9,  20, 14, 6],
      ];
      for (let i = 0; i < blocks.length; i++) {
        const b = blocks[i];
        const col = greens[(seed + i + Math.floor(Math.random() * greens.length)) % greens.length];
        px(b[0], b[1], b[2], b[3], col);
      }

      g.fillStyle = "rgba(255,255,255,0.10)";
      g.fillRect(9, 24, 3, 3);

      const tex = new THREE.CanvasTexture(c);
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.magFilter = THREE.NearestFilter;
      tex.minFilter = THREE.NearestFilter;
      tex.generateMipmaps = false;
      return tex;
    }

    const trees = [];
    function addTree(x, z, scale = 1, seed = 0) {
      const geo = new THREE.PlaneGeometry(2.0, 4.0);
      const mat = new THREE.MeshBasicMaterial({
        map: makeTreeTexture(seed),
        transparent: true,
        depthWrite: false
      });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.position.set(x, 2.0, z);
      mesh.scale.setScalar(scale);
      mesh.userData.isTree = true;
      scene.add(mesh);
      trees.push(mesh);
    }

    for (let i = 0; i < 170; i++) {
      const r = 18 + Math.random() * 95;
      const a = Math.random() * Math.PI * 2;
      const x = Math.cos(a) * r + (Math.random() - 0.5) * 6;
      const z = Math.sin(a) * r + (Math.random() - 0.5) * 6;
      if (Math.abs(x) < 12 && Math.abs(z) < 12) continue;
      addTree(x, z, 0.8 + Math.random() * 1.7, i);
    }

    /* Birds */
    function makeBirdTexture(type = 0) {
      const c = document.createElement("canvas");
      c.width = 32;
      c.height = 16;
      const g = c.getContext("2d");
      g.clearRect(0,0,c.width,c.height);

      const palettes = [
        { body:"#dfe7ff", wing:"#a9b6d8", eye:"#111111" },
        { body:"#1a1a1a", wing:"#2c2c2c", eye:"#e7e7e7" },
        { body:"#c97b2e", wing:"#9b5420", eye:"#111111" },
        { body:"#6fd4ff", wing:"#3aa9d6", eye:"#111111" },
      ];
      const p = palettes[type] || palettes[0];

      function px(x,y,w,h,color){ g.fillStyle = color; g.fillRect(x,y,w,h); }

      px(14, 7, 6, 3, p.body);
      px(11, 6, 3, 2, p.wing);
      px(20, 6, 3, 2, p.wing);
      px(9,  8, 6, 2, p.wing);
      px(17, 8, 6, 2, p.wing);

      px(20, 7, 2, 2, p.body);
      px(22, 8, 1, 1, p.eye);

      g.fillStyle = "rgba(0,0,0,0.25)";
      g.fillRect(14, 10, 6, 1);

      const tex = new THREE.CanvasTexture(c);
      tex.colorSpace = THREE.SRGBColorSpace;
      tex.magFilter = THREE.NearestFilter;
      tex.minFilter = THREE.NearestFilter;
      tex.generateMipmaps = false;
      return tex;
    }

    function makeBirdMaterial(type) {
      return new THREE.MeshBasicMaterial({
        map: makeBirdTexture(type),
        transparent: true,
        depthWrite: false
      });
    }

    const birdTypes = [
      { name: "Sparrow", points: 1, speed: 6.5, size: 0.9, hp: 1, mat: makeBirdMaterial(0) },
      { name: "Crow",    points: 2, speed: 8.5, size: 1.1, hp: 1, mat: makeBirdMaterial(1) },
      { name: "Hawk",    points: 3, speed: 10.0, size: 1.2, hp: 1, mat: makeBirdMaterial(2) },
    ];
    const rareType = { name:"Glitchbird", points: 8, speed: 12.0, size: 1.4, hp: 1, mat: makeBirdMaterial(3) };

    const birds = [];
    const birdGeo = new THREE.PlaneGeometry(1.8, 0.9);

    function spawnBird() {
      const isRare = Math.random() < 0.06;
      const t = isRare ? rareType : birdTypes[Math.floor(Math.random() * birdTypes.length)];

      const mesh = new THREE.Mesh(birdGeo, t.mat.clone());
      mesh.userData.type = t;

      const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
      dir.y = 0;
      dir.normalize();

      const right = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();
      const forwardDist = 34 + Math.random() * 80;
      const sideDist = (Math.random() - 0.5) * 90;

      const start = controls.getObject().position.clone();
      start.y = 9 + Math.random() * 10;

      const pos = start
        .add(dir.multiplyScalar(forwardDist))
        .add(right.multiplyScalar(sideDist));

      mesh.position.copy(pos);
      mesh.scale.setScalar(t.size);

      const flyRight = (Math.random() < 0.5 ? -1 : 1);
      const v = right.clone().multiplyScalar(flyRight * (t.speed + Math.random() * 2.7));
      v.add(new THREE.Vector3((Math.random()-0.5) * 2.2, (Math.random()-0.5) * 0.7, (Math.random()-0.5) * 2.2));

      mesh.userData.vel = v;
      mesh.userData.life = 8 + Math.random() * 8;
      mesh.userData.hp = t.hp;

      scene.add(mesh);
      birds.push(mesh);
    }

    /* Ambient motes */
    const motes = [];
    const moteGeo = new THREE.PlaneGeometry(0.18, 0.18);
    const moteCanvas = document.createElement("canvas");
    moteCanvas.width = 8; moteCanvas.height = 8;
    const mg = moteCanvas.getContext("2d");
    mg.fillStyle = "rgba(200,255,220,0.9)";
    mg.fillRect(3,3,2,2);
    const moteTex = new THREE.CanvasTexture(moteCanvas);
    moteTex.colorSpace = THREE.SRGBColorSpace;
    moteTex.magFilter = THREE.NearestFilter;
    moteTex.minFilter = THREE.NearestFilter;
    moteTex.generateMipmaps = false;
    const moteMat = new THREE.MeshBasicMaterial({ map: moteTex, transparent: true, opacity: 0.55, depthWrite: false });

    for (let i = 0; i < 140; i++) {
      const m = new THREE.Mesh(moteGeo, moteMat.clone());
      m.position.set((Math.random()-0.5)*90, 1 + Math.random()*20, (Math.random()-0.5)*90);
      m.userData.v = new THREE.Vector3((Math.random()-0.5)*0.30, (Math.random()-0.5)*0.08, (Math.random()-0.5)*0.30);
      scene.add(m);
      motes.push(m);
    }

    function updateMotes(dt) {
      const p = controls.getObject().position;
      for (const m of motes) {
        m.position.addScaledVector(m.userData.v, dt);
        m.lookAt(camera.position.x, camera.position.y, camera.position.z);

        if (m.position.distanceTo(p) > 78) {
          m.position.set(p.x + (Math.random()-0.5)*78, 1 + Math.random()*20, p.z + (Math.random()-0.5)*78);
        }
      }
    }

    /* HUD and game state */
    let score = 0;
    let ammo = MAG_SIZE;
    let timeLeft = GAME_SECONDS;
    let running = false;

    let shots = 0;
    let hits = 0;
    let streak = 0;
    let maxStreak = 0;

    ammoMaxEl.textContent = MAG_SIZE;

    function updateHUD() {
      scoreEl.textContent = String(score);
      timeEl.textContent = String(Math.max(0, Math.floor(timeLeft)));
      ammoEl.textContent = String(ammo);
      barFill.style.width = `${(ammo / MAG_SIZE) * 100}%`;

      if (streak >= 3) {
        streakPill.style.display = "inline-block";
        streakPill.textContent = `Streak x${streak}`;
      } else {
        streakPill.style.display = "none";
      }
    }

    function setMenuVisible(vis) {
      menu.style.display = vis ? "grid" : "none";
    }

    function resetStats() {
      shots = 0;
      hits = 0;
      streak = 0;
      maxStreak = 0;
    }

    function clearBirds() {
      for (const b of birds) scene.remove(b);
      birds.length = 0;
    }

    function resetGame() {
      score = 0;
      ammo = MAG_SIZE;
      timeLeft = GAME_SECONDS;
      running = false;
      pendingStart = false;
      endStats.style.display = "none";
      endStats.textContent = "";
      clearBirds();
      resetStats();

      controls.getObject().position.set(0, 1.7, 8);
      controls.getObject().rotation.set(0, 0, 0);

      updateHUD();
      showMsg("Ready", 650);
    }

    function endGame() {
      running = false;
      if (score > bestScore) {
        bestScore = score;
        saveBest(bestScore);
        bestEl.textContent = String(bestScore);
        showMsg("New Best", 900);
        beep(880, 0.07, "square");
        beep(1320, 0.07, "square");
      } else {
        showMsg("Time Up", 1100);
        beep(220, 0.08, "sawtooth");
      }

      const acc = shots > 0 ? Math.round((hits / shots) * 100) : 0;
      endStats.style.display = "block";
      endStats.innerHTML =
        `<b>Run Summary</b><br>` +
        `Score: <b>${score}</b><br>` +
        `Shots: ${shots} | Hits: ${hits} | Accuracy: ${acc}%<br>` +
        `Max streak: ${maxStreak}<br>` +
        `Press Start to go again.`;

      setMenuVisible(true);
      if (controls.isLocked) controls.unlock();
    }

    /* Raycast shooting */
    const raycaster = new THREE.Raycaster();
    raycaster.far = 260;

    function shoot() {
      if (!running) return;
      if (!controls.isLocked) return;

      ensureAudio();
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});

      if (ammo <= 0) {
        showMsg("Reload", 650);
        beep(180, 0.05, "square");
        return;
      }

      ammo -= 1;
      shots += 1;
      updateHUD();

      controls.getObject().rotation.x -= 0.01;

      raycaster.setFromCamera({ x: 0, y: 0 }, camera);
      const hitsList = raycaster.intersectObjects(birds, false);

      beep(520 + Math.random() * 60, 0.03, "square");

      if (hitsList.length) {
        const hitObj = hitsList[0].object;
        const t = hitObj.userData.type;

        hits += 1;
        streak += 1;
        maxStreak = Math.max(maxStreak, streak);

        let add = t.points;
        if (streak >= 4) add += 1;
        if (streak >= 7) add += 1;

        score += add;
        updateHUD();

        hitObj.scale.multiplyScalar(1.18);
        hitObj.material.opacity = 0.28;

        scene.remove(hitObj);
        birds.splice(birds.indexOf(hitObj), 1);

        showMsg(`+${add} ${t.name}`, 650);
        beep(740 + Math.random() * 90, 0.04, "triangle");
      } else {
        streak = 0;
        updateHUD();
        showMsg("Miss", 360);
      }
    }

    function reload() {
      if (!running) return;
      ensureAudio();
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
      ammo = MAG_SIZE;
      updateHUD();
      showMsg("Reloaded", 650);
      beep(300, 0.04, "square");
      beep(420, 0.04, "square");
    }

    /* Movement */
    const keys = { w:false, a:false, s:false, d:false, shift:false };

    function setKey(e, down) {
      const k = e.key.toLowerCase();
      if (k === "w") keys.w = down;
      if (k === "a") keys.a = down;
      if (k === "s") keys.s = down;
      if (k === "d") keys.d = down;
      if (k === "shift") keys.shift = down;

      if (down && k === "r") reload();

      if (down && k === "escape") {
        if (controls.isLocked) {
          controls.unlock();
        } else {
          if (menu.style.display === "none") {
            setMenuVisible(true);
          }
        }
      }
    }

    window.addEventListener("keydown", (e) => setKey(e, true));
    window.addEventListener("keyup", (e) => setKey(e, false));

    window.addEventListener("mousedown", (e) => {
      if (e.button === 0) shoot();
    });

    /* Trackpad support */
    renderer.domElement.addEventListener("pointerdown", (e) => {
      if (e.button === 0) {
        if (controls.isLocked && running) {
          shoot();
        }
      }
    });

    /* Pixel render sizing */
    function applyQuality() {
      const q = qualityPresets[qualityIndex];
      renderer.setSize(q.w, q.h, false);
      camera.aspect = q.w / q.h;
      camera.updateProjectionMatrix();
      qualityBtn.textContent = `Pixel Quality: ${q.name}`;
    }

    function onResize() {
      renderer.domElement.style.width = "100vw";
      renderer.domElement.style.height = "100vh";
    }
    window.addEventListener("resize", onResize);

    /* Billboard facing */
    function faceBillboards() {
      for (const t of trees) {
        t.lookAt(camera.position.x, t.position.y, camera.position.z);
      }
      for (const b of birds) {
        b.lookAt(camera.position.x, b.position.y, camera.position.z);
      }
      for (const m of motes) {
        m.lookAt(camera.position.x, camera.position.y, camera.position.z);
      }
    }

    /* Day night vibe shift */
    let skyT = 0;
    function updateSky(dt) {
      skyT += dt * 0.02;
      const pulse = 0.5 + 0.5 * Math.sin(skyT);
      const fogBase = 0.024 + pulse * 0.012;
      scene.fog.density = fogBase;

      hemi.intensity = 0.62 + pulse * 0.22;
      sun.intensity = 0.75 + pulse * 0.25;

      const skyCol = new THREE.Color().setHSL(0.60, 0.45, 0.10 + pulse * 0.06);
      sky.material.color.copy(skyCol);
    }

    /* Game clock */
    let last = performance.now();
    let spawnTimer = 0;

    function tick(now) {
      const dt = Math.min(0.033, (now - last) / 1000);
      last = now;

      updateSky(dt);

      if (running) {
        timeLeft -= dt;
        if (timeLeft <= 0) {
          timeLeft = 0;
          updateHUD();
          endGame();
        } else {
          updateHUD();
        }

        spawnTimer -= dt;
        const spawnRate = 0.52;
        if (spawnTimer <= 0) {
          spawnTimer = spawnRate + Math.random() * 0.60;
          spawnBird();
          if (Math.random() < 0.14) spawnBird();
        }

        for (let i = birds.length - 1; i >= 0; i--) {
          const b = birds[i];
          b.position.addScaledVector(b.userData.vel, dt);
          b.userData.life -= dt;

          b.position.y += Math.sin((now * 0.004) + i) * 0.002;

          if (b.userData.life <= 0) {
            scene.remove(b);
            birds.splice(i, 1);
          }
        }

        const obj = controls.getObject();
        const speed = keys.shift ? 8.0 : 4.8;

        const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
        forward.y = 0;
        forward.normalize();

        const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
        right.y = 0;
        right.normalize();

        const move = new THREE.Vector3();
        if (keys.w) move.add(forward);
        if (keys.s) move.sub(forward);
        if (keys.d) move.add(right);
        if (keys.a) move.sub(right);

        if (move.lengthSq() > 0) {
          move.normalize().multiplyScalar(speed * dt);
          obj.position.add(move);
        }

        obj.position.y = 1.7;
        obj.position.x = THREE.MathUtils.clamp(obj.position.x, -100, 100);
        obj.position.z = THREE.MathUtils.clamp(obj.position.z, -100, 100);
      }

      updateMotes(dt);
      faceBillboards();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    }

    /* Menu buttons */
    howBtn.addEventListener("click", () => {
      tips.style.display = (tips.style.display === "none") ? "block" : "none";
    });

    qualityBtn.addEventListener("click", () => {
      qualityIndex = (qualityIndex + 1) % qualityPresets.length;
      applyQuality();
      showMsg("Quality set", 650);
    });

    restartBtn.addEventListener("click", () => {
      ensureAudio();
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
      resetGame();
      setMenuVisible(true);
      showMsg("Restarted", 700);
      beep(360, 0.05, "square");
      beep(520, 0.05, "square");
      if (controls.isLocked) controls.unlock();
    });

    /* Sensitivity and audio UI */
    function syncUI() {
      mouseSensitivity = Number(sensSlider.value);
      sensVal.textContent = mouseSensitivity.toFixed(2);
      controls.pointerSpeed = mouseSensitivity;

      audioVal.textContent = String(audioSlider.value);
      setAudioVolume();
    }
    sensSlider.addEventListener("input", syncUI);
    audioSlider.addEventListener("input", () => {
      ensureAudio();
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
      syncUI();
      beep(420, 0.03, "triangle");
    });

    /* Start flow that works on trackpad and avoids duplicate handlers */
    let pendingStart = false;

    function beginRun() {
      if (!running) {
        running = true;
        showMsg("Go", 650);
        beep(660, 0.05, "triangle");
      }
    }

    function requestLock() {
      try {
        controls.lock();
      } catch (err) {
        showMsg("Pointer lock blocked. Click Start again.", 1200);
      }
    }

    startBtn.addEventListener("click", () => {
      ensureAudio();
      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume().catch(() => {});

      endStats.style.display = "none";
      endStats.textContent = "";

      setMenuVisible(false);
      pendingStart = true;

      showMsg("Click inside to lock mouse", 1000);
      requestLock();
    });

    /* Click inside canvas: if not locked, lock. If locked and pending, start. */
    renderer.domElement.addEventListener("click", () => {
      if (menu.style.display !== "none") return;

      if (!controls.isLocked) {
        requestLock();
        return;
      }
      if (pendingStart) {
        pendingStart = false;
        beginRun();
      }
    });

    controls.addEventListener("lock", () => {
      showMsg("Locked", 450);
      if (pendingStart) {
        pendingStart = false;
        beginRun();
      }
    });

    controls.addEventListener("unlock", () => {
      if (running) {
        showMsg("Paused", 650);
        setMenuVisible(true);
      }
    });

    /* Prevent stuck pending start if menu is visible */
    function safeShowMenu() {
      pendingStart = false;
      setMenuVisible(true);
    }

    /* Boot */
    syncUI();
    applyQuality();
    onResize();
    resetGame();
    updateHUD();
    requestAnimationFrame(tick);

    /* Extra: avoid scrolling and accidental gestures */
    window.addEventListener("wheel", (e) => {
      if (controls.isLocked) e.preventDefault();
    }, { passive: false });

    /* If pointer lock is not supported */
    if (!("pointerLockElement" in document)) {
      showMsg("Pointer lock not supported in this browser.", 1400);
      safeShowMenu();
    }
  </script>
</body>
</html>
